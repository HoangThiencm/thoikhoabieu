<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>In TKB - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/babel" src="js/common.js"></script>
    <style>
        @media print {
            aside, button, select, .no-print { display: none !important; }
            main { margin-left: 0 !important; padding: 0 !important; }
            body { background: white; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function PrintPage() {
            const [classes, setClasses] = React.useState([]);
            const [results, setResults] = React.useState([]);
            const [selectedClass, setSelectedClass] = React.useState("");
            
            // L·∫•y task_id g·∫ßn nh·∫•t ƒë√£ ho√†n th√†nh ƒë·ªÉ in
            const loadLastResult = async () => {
                // Logic ƒë∆°n gi·∫£n: L·∫•y k·∫øt qu·∫£ c·ªßa l·∫ßn ch·∫°y cu·ªëi c√πng
                // Th·ª±c t·∫ø c·∫ßn API l·∫•y "latest task", ·ªü ƒë√¢y t·∫°m th·ªùi l·∫•y t·∫•t c·∫£ results c·ªßa task m·ªõi nh·∫•t
                // (Gi·∫£ l·∫≠p: B·∫°n c·∫ßn nh·∫≠p Task ID ho·∫∑c ch·ªçn t·ª´ list)
                const c = await window.api.call("/classes/");
                setClasses(c || []);
            };
            React.useEffect(() => { loadLastResult(); }, []);

            // V√¨ API hi·ªán t·∫°i y√™u c·∫ßu TaskID, ta l√†m √¥ nh·∫≠p TaskID t·∫°m th·ªùi
            const [tid, setTid] = React.useState(""); 
            const fetchTKB = async () => {
                if(!tid) return alert("C·∫ßn nh·∫≠p M√£ Task ID t·ª´ trang X·∫øp TKB");
                const res = await window.api.call(`/generate/results/${tid}`);
                setResults(res || []);
            };

            const TKBTable = ({ classId, className }) => {
                const schedule = results.filter(r => r.class_id === classId);
                if(schedule.length === 0) return null;

                return (
                    <div className="mb-8 p-4 border rounded print:border-2 print:border-black">
                        <h2 className="text-xl font-bold text-center mb-4 uppercase">Th·ªùi Kh√≥a Bi·ªÉu L·ªõp {className}</h2>
                        <table className="w-full text-center border-collapse border border-black">
                            <thead>
                                <tr>
                                    <th className="border border-black p-2 bg-gray-100 print:bg-white">Ti·∫øt</th>
                                    {["Hai","Ba","T∆∞","NƒÉm","S√°u"].map(d=><th key={d} className="border border-black p-2 font-bold">Th·ª© {d}</th>)}
                                </tr>
                            </thead>
                            <tbody>
                                {[0,1,2,3,4,5,6,7,8].map(p => (
                                    <tr key={p}>
                                        <td className="border border-black p-2 font-bold">{p+1}</td>
                                        {[0,1,2,3,4].map(d => {
                                            const slot = schedule.find(r => r.day === d && r.period === p);
                                            return (
                                                <td key={d} className="border border-black p-2 h-12 align-middle">
                                                    {slot ? (
                                                        <div>
                                                            <div className="font-bold">{slot.subjects?.name}</div>
                                                            <div className="text-xs italic">{slot.teachers?.short_name}</div>
                                                        </div>
                                                    ) : ""}
                                                </td>
                                            );
                                        })}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            };

            return (
                <window.AppLayout>
                    <div className="no-print mb-6 flex gap-4 items-end bg-white p-4 rounded shadow">
                        <div className="flex-1">
                            <label className="text-sm font-bold block">Nh·∫≠p Task ID (L·∫•y t·ª´ trang X·∫øp TKB)</label>
                            <input value={tid} onChange={e=>setTid(e.target.value)} className="border p-2 w-full rounded" placeholder="V√≠ d·ª•: b4f8..."/>
                        </div>
                        <button onClick={fetchTKB} className="bg-blue-600 text-white px-4 py-2 rounded font-bold">T·∫£i D·ªØ Li·ªáu</button>
                        <button onClick={()=>window.print()} className="bg-gray-800 text-white px-4 py-2 rounded font-bold">üñ®Ô∏è In Ngay</button>
                    </div>

                    {/* Ch·∫ø ƒë·ªô in t·∫•t c·∫£ ho·∫∑c in 1 l·ªõp */}
                    <div className="no-print mb-4">
                        <select onChange={e=>setSelectedClass(e.target.value)} className="border p-2 rounded">
                            <option value="">-- In T·∫•t C·∫£ C√°c L·ªõp --</option>
                            {classes.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                        </select>
                    </div>

                    <div id="print-area">
                        {selectedClass ? (
                            <TKBTable classId={selectedClass} className={classes.find(c=>c.id===selectedClass)?.name} />
                        ) : (
                            classes.map(c => (
                                <div key={c.id} className="page-break">
                                    <TKBTable classId={c.id} className={c.name} />
                                </div>
                            ))
                        )}
                    </div>
                </window.AppLayout>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<PrintPage />);
    </script>
</body>
</html>
