<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi√°o Vi√™n - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/babel" src="js/common.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function TeacherPage() {
            const [data, setData] = React.useState([]);
            const [form, setForm] = React.useState({ name: "", short_name: "", specialization: "" });
            // State ƒë·ªÉ theo d√µi ƒëang s·ª≠a gi√°o vi√™n n√†o
            const [editingId, setEditingId] = React.useState(null);

            const load = async () => setData(await window.api.call("/teachers/") || []);
            React.useEffect(() => { load(); }, []);

            const handleSubmit = async () => {
                if(!form.name) return alert("Vui l√≤ng nh·∫≠p t√™n gi√°o vi√™n!");
                
                if (editingId) {
                    // Logic C·∫≠p nh·∫≠t (Edit)
                    await window.api.call(`/teachers/${editingId}`, "PUT", form);
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    setEditingId(null);
                } else {
                    // Logic Th√™m m·ªõi (Add)
                    await window.api.call("/teachers/", "POST", form);
                }
                
                // Reset form sau khi l∆∞u
                setForm({ name: "", short_name: "", specialization: "" });
                load();
            };

            const handleEdit = (item) => {
                // ƒê·ªï d·ªØ li·ªáu l√™n form ƒë·ªÉ s·ª≠a
                setForm({
                    name: item.name,
                    short_name: item.short_name || "",
                    specialization: item.specialization || ""
                });
                setEditingId(item.id);
                // Cu·ªôn l√™n ƒë·∫ßu trang
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleCancel = () => {
                setForm({ name: "", short_name: "", specialization: "" });
                setEditingId(null);
            };

            const del = async (id) => {
                if(confirm("X√≥a gi√°o vi√™n n√†y s·∫Ω m·∫•t c√°c ph√¢n c√¥ng li√™n quan. Ti·∫øp t·ª•c?")) {
                    await window.api.call(`/teachers/${id}`, "DELETE");
                    load();
                }
            };

            const handleImport = (e) => {
                window.excel.import(e.target.files[0], async (rows) => {
                    let count = 0;
                    for(const r of rows) {
                        const name = r["H·ªç t√™n"] || r["Name"] || r["name"];
                        const short = r["T√™n t·∫Øt"] || r["ShortName"] || r["short_name"];
                        const spec = r["Chuy√™n m√¥n"] || r["Specialization"] || r["specialization"] || "";
                        
                        if(name) {
                            await window.api.call("/teachers/", "POST", { 
                                name, 
                                short_name: short,
                                specialization: spec 
                            });
                            count++;
                        }
                    }
                    alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${count} gi√°o vi√™n.`);
                    load();
                    e.target.value = null; 
                });
            };

            return (
                <window.AppLayout>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800">Qu·∫£n l√Ω Gi√°o vi√™n</h1>
                        <div className="flex gap-2">
                            <button onClick={() => window.excel.export(data, "DS_GiaoVien.xlsx")} className="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 shadow flex items-center gap-2">
                                üì§ Xu·∫•t Excel
                            </button>
                            <label className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 cursor-pointer shadow flex items-center gap-2">
                                üì• Nh·∫≠p Excel <input type="file" onChange={handleImport} hidden accept=".xlsx"/>
                            </label>
                        </div>
                    </div>

                    {/* Form th√™m m·ªõi / Ch·ªânh s·ª≠a */}
                    <div className={`p-6 rounded-xl shadow-sm mb-8 border transition-colors ${editingId ? 'bg-orange-50 border-orange-200' : 'bg-white border-gray-200'}`}>
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className={`font-bold ${editingId ? 'text-orange-700' : 'text-gray-700'}`}>
                                {editingId ? "‚úèÔ∏è ƒêang ch·ªânh s·ª≠a th√¥ng tin" : "Th√™m gi√°o vi√™n m·ªõi"}
                            </h3>
                            {editingId && <button onClick={handleCancel} className="text-xs text-gray-500 hover:text-gray-800 underline">H·ªßy b·ªè</button>}
                        </div>
                        
                        <div className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="text-sm font-bold text-gray-600 mb-1 block">H·ªç v√† T√™n</label>
                                <input value={form.name} onChange={e=>setForm({...form, name: e.target.value})} className="border border-gray-300 p-2.5 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A"/>
                            </div>
                            <div className="w-full md:w-1/4">
                                <label className="text-sm font-bold text-gray-600 mb-1 block">T√™n t·∫Øt (M√£)</label>
                                <input value={form.short_name} onChange={e=>setForm({...form, short_name: e.target.value})} className="border border-gray-300 p-2.5 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" placeholder="GvA"/>
                            </div>
                            <div className="w-full md:w-1/4">
                                <label className="text-sm font-bold text-gray-600 mb-1 block">Chuy√™n m√¥n</label>
                                <input value={form.specialization} onChange={e=>setForm({...form, specialization: e.target.value})} className="border border-gray-300 p-2.5 rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" placeholder="To√°n, L√Ω..."/>
                            </div>
                            
                            <div className="flex gap-2 w-full md:w-auto">
                                {editingId ? (
                                    <>
                                        <button onClick={handleCancel} className="bg-gray-500 text-white px-4 py-2.5 rounded-lg font-bold hover:bg-gray-600 shadow transition w-full md:w-auto">
                                            H·ªßy
                                        </button>
                                        <button onClick={handleSubmit} className="bg-orange-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-orange-700 shadow transition w-full md:w-auto">
                                            L∆∞u thay ƒë·ªïi
                                        </button>
                                    </>
                                ) : (
                                    <button onClick={handleSubmit} className="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-lg transform active:scale-95 transition w-full md:w-auto">
                                        + Th√™m
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Danh s√°ch */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {data.map(item => (
                            <div key={item.id} className={`bg-white p-5 border rounded-xl shadow-sm hover:shadow-md transition flex justify-between items-start group ${editingId === item.id ? 'ring-2 ring-orange-400' : 'border-gray-200'}`}>
                                <div>
                                    <div className="font-bold text-gray-800 text-lg">{item.name}</div>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded font-mono">{item.short_name || "---"}</span>
                                        {item.specialization && (
                                            <span className="bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded font-bold">{item.specialization}</span>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => handleEdit(item)} className="text-gray-400 hover:text-blue-600 p-2 rounded-full hover:bg-blue-50" title="Ch·ªânh s·ª≠a">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                    </button>
                                    <button onClick={()=>del(item.id)} className="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50" title="X√≥a">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                    </button>
                                </div>
                            </div>
                        ))}
                        {data.length === 0 && (
                            <div className="col-span-full text-center py-10 text-gray-400 bg-gray-50 rounded-xl border border-dashed">
                                Ch∆∞a c√≥ d·ªØ li·ªáu gi√°o vi√™n. H√£y th√™m m·ªõi ho·∫∑c nh·∫≠p t·ª´ Excel.
                            </div>
                        )}
                    </div>
                </window.AppLayout>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<TeacherPage />);
    </script>
</body>
</html>
