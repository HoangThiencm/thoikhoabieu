<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi√°o Vi√™n - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/babel" src="js/common.js"></script>
    <style>
        .busy-cell { cursor: pointer; transition: all 0.2s; }
        .busy-cell:hover { opacity: 0.8; }
        .busy-cell.active { background-color: #f87171; color: white; font-weight: bold; } /* M√†u ƒë·ªè nh·∫°t */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function TeacherPage() {
            const [teachers, setTeachers] = React.useState([]);
            const [subjects, setSubjects] = React.useState([]);
            // Gi·∫£ l·∫≠p danh s√°ch t·ªï chuy√™n m√¥n (th·ª±c t·∫ø n√™n l·∫•y t·ª´ API n·∫øu c√≥ b·∫£ng groups)
            const [groups, setGroups] = React.useState(["To√°n - Tin", "VƒÉn - S·ª≠ - ƒê·ªãa", "KHTN", "Ngo·∫°i ng·ªØ", "Ngh·ªá thu·∫≠t", "GDTC"]);
            const [roles, setRoles] = React.useState(["Gi√°o vi√™n", "T·ªï tr∆∞·ªüng", "Ph√≥ hi·ªáu tr∆∞·ªüng", "Th·ªânh gi·∫£ng"]);

            const [form, setForm] = React.useState({
                name: "", short_name: "", email: "", 
                professional_group_name: "", role: "Gi√°o vi√™n", target_periods: 19,
                subjects: [], secondary_subjects: [], 
                unavailable_periods: [] // M·∫£ng c√°c object {day: 0, period: 1}
            });
            
            const [editingId, setEditingId] = React.useState(null);
            const [showForm, setShowForm] = React.useState(false); // ·∫®n/hi·ªán form

            // H√†m load d·ªØ li·ªáu
            const loadData = async () => {
                const sessionId = window.api.getSessionId();
                if (!sessionId) return;
                
                const [tData, sData] = await Promise.all([
                    window.api.call(`/teachers/?session_id=${sessionId}`),
                    window.api.call(`/subjects/?session_id=${sessionId}`) // C·∫ßn API l·∫•y m√¥n h·ªçc
                ]);
                
                setTeachers(tData || []);
                setSubjects(sData || []);
            };

            React.useEffect(() => { loadData(); }, []);

            const handleSubmit = async () => {
                if(!form.name) return alert("Vui l√≤ng nh·∫≠p t√™n gi√°o vi√™n!");
                
                const sessionId = window.api.getSessionId();
                if (!sessionId) return alert("L·ªói: Ch∆∞a x√°c ƒë·ªãnh phi√™n l√†m vi·ªác.");

                // Chu·∫©n h√≥a d·ªØ li·ªáu tr∆∞·ªõc khi g·ª≠i
                const payload = {
                    ...form,
                    session_id: sessionId,
                    // ƒê·∫£m b·∫£o ki·ªÉu d·ªØ li·ªáu ƒë√∫ng v·ªõi Backend Model
                    target_periods: parseInt(form.target_periods) || 0,
                    // Backend nh·∫≠n unavailable_periods l√† list object
                    unavailable_periods: form.unavailable_periods
                };
                
                if (editingId) {
                    await window.api.call(`/teachers/${editingId}`, "PUT", payload);
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                } else {
                    await window.api.call("/teachers/", "POST", payload);
                    alert("Th√™m m·ªõi th√†nh c√¥ng!");
                }
                
                resetForm();
                loadData();
            };

            const resetForm = () => {
                setForm({
                    name: "", short_name: "", email: "", 
                    professional_group_name: "", role: "Gi√°o vi√™n", target_periods: 19,
                    subjects: [], secondary_subjects: [], 
                    unavailable_periods: []
                });
                setEditingId(null);
                setShowForm(false);
            };

            const handleEdit = (item) => {
                setForm({
                    name: item.name,
                    short_name: item.short_name || "",
                    email: item.email || "",
                    professional_group_name: item.professional_group_name || "",
                    role: item.role || "Gi√°o vi√™n",
                    target_periods: item.target_periods || 19,
                    subjects: item.subjects || [], // Backend c·∫ßn tr·∫£ v·ªÅ m·∫£ng t√™n m√¥n h·ªçc
                    secondary_subjects: item.secondary_subjects || [],
                    unavailable_periods: item.unavailable_periods || []
                });
                setEditingId(item.id);
                setShowForm(true);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const del = async (id) => {
                if(confirm("X√≥a gi√°o vi√™n n√†y s·∫Ω m·∫•t c√°c ph√¢n c√¥ng li√™n quan. Ti·∫øp t·ª•c?")) {
                    await window.api.call(`/teachers/${id}`, "DELETE");
                    loadData();
                }
            };

            // H√†m x·ª≠ l√Ω ch·ªçn m√¥n h·ªçc (ƒëa ch·ªçn)
            const toggleSubject = (subjName, isSecondary = false) => {
                const field = isSecondary ? 'secondary_subjects' : 'subjects';
                const currentList = form[field];
                if (currentList.includes(subjName)) {
                    setForm({ ...form, [field]: currentList.filter(s => s !== subjName) });
                } else {
                    setForm({ ...form, [field]: [...currentList, subjName] });
                }
            };

            // H√†m x·ª≠ l√Ω ch·ªçn l·ªãch b·∫≠n
            const toggleBusySlot = (day, period) => {
                const currentSlots = form.unavailable_periods;
                const exists = currentSlots.some(s => s.day === day && s.period === period);
                
                if (exists) {
                    setForm({ ...form, unavailable_periods: currentSlots.filter(s => !(s.day === day && s.period === period)) });
                } else {
                    setForm({ ...form, unavailable_periods: [...currentSlots, { day, period }] });
                }
            };

            const isBusy = (day, period) => {
                return form.unavailable_periods.some(s => s.day === day && s.period === period);
            };

            return (
                <window.AppLayout>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800">Qu·∫£n l√Ω Gi√°o vi√™n</h1>
                        <div className="flex gap-2">
                            <button onClick={() => { resetForm(); setShowForm(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 shadow flex items-center gap-2">
                                + Th√™m Gi√°o Vi√™n
                            </button>
                            <button onClick={() => window.excel.export(teachers, "DS_GiaoVien.xlsx")} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 shadow flex items-center gap-2">
                                üì§ Xu·∫•t Excel
                            </button>
                        </div>
                    </div>

                    {/* FORM NH·∫¨P LI·ªÜU CHI TI·∫æT */}
                    {showForm && (
                        <div className="bg-white p-6 rounded-xl shadow-lg border border-blue-200 mb-8 animate-fade-in-down">
                            <div className="flex justify-between items-center mb-6 border-b pb-2">
                                <h3 className="font-bold text-xl text-blue-800">
                                    {editingId ? "‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin" : "‚ú® Th√™m gi√°o vi√™n m·ªõi"}
                                </h3>
                                <button onClick={resetForm} className="text-gray-500 hover:text-red-500 font-bold">‚úï ƒê√≥ng</button>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                {/* C·ªôt Tr√°i: Th√¥ng tin c∆° b·∫£n */}
                                <div className="space-y-4">
                                    <h4 className="font-bold text-gray-700 border-l-4 border-blue-500 pl-2">1. Th√¥ng tin c√° nh√¢n</h4>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="col-span-2">
                                            <label className="text-sm font-semibold block mb-1">H·ªç v√† T√™n (*)</label>
                                            <input value={form.name} onChange={e=>setForm({...form, name: e.target.value})} className="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300 outline-none" placeholder="Nguy·ªÖn VƒÉn A"/>
                                        </div>
                                        <div>
                                            <label className="text-sm font-semibold block mb-1">M√£ GV / T√™n t·∫Øt</label>
                                            <input value={form.short_name} onChange={e=>setForm({...form, short_name: e.target.value})} className="border p-2 rounded w-full" placeholder="GVA"/>
                                        </div>
                                        <div>
                                            <label className="text-sm font-semibold block mb-1">Email</label>
                                            <input value={form.email} onChange={e=>setForm({...form, email: e.target.value})} className="border p-2 rounded w-full" placeholder="email@example.com"/>
                                        </div>
                                        <div>
                                            <label className="text-sm font-semibold block mb-1">T·ªï Chuy√™n M√¥n</label>
                                            <select value={form.professional_group_name} onChange={e=>setForm({...form, professional_group_name: e.target.value})} className="border p-2 rounded w-full">
                                                <option value="">-- Ch·ªçn T·ªï --</option>
                                                {groups.map(g => <option key={g} value={g}>{g}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-sm font-semibold block mb-1">Vai tr√≤</label>
                                            <select value={form.role} onChange={e=>setForm({...form, role: e.target.value})} className="border p-2 rounded w-full">
                                                {roles.map(r => <option key={r} value={r}>{r}</option>)}
                                            </select>
                                        </div>
                                        <div className="col-span-2">
                                            <label className="text-sm font-semibold block mb-1">S·ªë ti·∫øt ƒë·ªãnh m·ª©c / tu·∫ßn</label>
                                            <input type="number" value={form.target_periods} onChange={e=>setForm({...form, target_periods: e.target.value})} className="border p-2 rounded w-full" />
                                            <p className="text-xs text-gray-500 mt-1">S·ªë ti·∫øt chu·∫©n gi√°o vi√™n c·∫ßn d·∫°y.</p>
                                        </div>
                                    </div>

                                    <h4 className="font-bold text-gray-700 border-l-4 border-green-500 pl-2 mt-6">2. Chuy√™n m√¥n gi·∫£ng d·∫°y</h4>
                                    <div className="bg-gray-50 p-3 rounded border">
                                        <div className="mb-2 font-semibold text-sm">M√¥n ch√≠nh (C√≥ th·ªÉ ch·ªçn nhi·ªÅu):</div>
                                        <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                            {subjects.map(s => (
                                                <label key={s.id} className={`cursor-pointer px-2 py-1 rounded text-xs border ${form.subjects.includes(s.name) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600'}`}>
                                                    <input type="checkbox" hidden checked={form.subjects.includes(s.name)} onChange={() => toggleSubject(s.name, false)} />
                                                    {s.name}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded border mt-2">
                                        <div className="mb-2 font-semibold text-sm">M√¥n ki√™m nhi·ªám (D·∫°y th√™m):</div>
                                        <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                            {subjects.map(s => (
                                                <label key={s.id} className={`cursor-pointer px-2 py-1 rounded text-xs border ${form.secondary_subjects.includes(s.name) ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600'}`}>
                                                    <input type="checkbox" hidden checked={form.secondary_subjects.includes(s.name)} onChange={() => toggleSubject(s.name, true)} />
                                                    {s.name}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* C·ªôt Ph·∫£i: L·ªãch b·∫≠n */}
                                <div>
                                    <h4 className="font-bold text-gray-700 border-l-4 border-red-500 pl-2 mb-4">3. ƒêƒÉng k√Ω L·ªãch b·∫≠n (Click ƒë·ªÉ ch·ªçn)</h4>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-center border-collapse text-sm">
                                            <thead>
                                                <tr>
                                                    <th className="border p-1 bg-gray-100 w-10">Ti·∫øt</th>
                                                    {["Hai","Ba","T∆∞","NƒÉm","S√°u","B·∫£y"].map((d, i) => <th key={i} className="border p-1 bg-gray-100">T{i+2}</th>)}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {/* Bu·ªïi s√°ng: Ti·∫øt 0-4 */}
                                                <tr className="bg-blue-50"><td colSpan="7" className="font-bold text-xs py-1 text-blue-700 text-left pl-2">BU·ªîI S√ÅNG</td></tr>
                                                {[0,1,2,3,4].map(period => (
                                                    <tr key={period}>
                                                        <td className="border font-bold text-gray-500">{period+1}</td>
                                                        {[0,1,2,3,4,5].map(day => (
                                                            <td key={day} 
                                                                onClick={() => toggleBusySlot(day, period)}
                                                                className={`border p-1 h-8 busy-cell ${isBusy(day, period) ? 'active' : ''}`}>
                                                                {isBusy(day, period) ? "B·∫¨N" : ""}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                                
                                                {/* Bu·ªïi chi·ªÅu: Ti·∫øt 5-9 */}
                                                <tr className="bg-orange-50"><td colSpan="7" className="font-bold text-xs py-1 text-orange-700 text-left pl-2">BU·ªîI CHI·ªÄU</td></tr>
                                                {[5,6,7,8,9].map(period => (
                                                    <tr key={period}>
                                                        <td className="border font-bold text-gray-500">{period-4}</td>
                                                        {[0,1,2,3,4,5].map(day => (
                                                            <td key={day} 
                                                                onClick={() => toggleBusySlot(day, period)}
                                                                className={`border p-1 h-8 busy-cell ${isBusy(day, period) ? 'active' : ''}`}>
                                                                {isBusy(day, period) ? "B·∫¨N" : ""}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="mt-4 flex justify-end gap-3">
                                        <button onClick={resetForm} className="px-4 py-2 rounded border hover:bg-gray-100">H·ªßy b·ªè</button>
                                        <button onClick={handleSubmit} className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 shadow">
                                            üíæ L∆∞u Gi√°o Vi√™n
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* DANH S√ÅCH GI√ÅO VI√äN */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {teachers.map(item => (
                            <div key={item.id} className="bg-white p-4 border rounded-xl shadow-sm hover:shadow-md transition group relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-2 opacity-0 group-hover:opacity-100 transition bg-white/90 rounded-bl-xl border-l border-b">
                                    <button onClick={() => handleEdit(item)} className="text-blue-600 mr-2 hover:underline">S·ª≠a</button>
                                    <button onClick={() => del(item.id)} className="text-red-500 hover:underline">X√≥a</button>
                                </div>
                                
                                <div className="flex items-start gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center font-bold text-gray-600 text-lg">
                                        {item.name.charAt(0)}
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800 text-lg leading-tight">{item.name}</div>
                                        <div className="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                            <span className="bg-gray-100 px-1.5 py-0.5 rounded border">{item.short_name || "---"}</span>
                                            <span>{item.email}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="mt-3 pt-3 border-t border-dashed space-y-1 text-sm">
                                    <div className="flex justify-between">
                                        <span className="text-gray-500">T·ªï CM:</span>
                                        <span className="font-medium">{item.professional_group_name || "---"}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-500">ƒê·ªãnh m·ª©c:</span>
                                        <span className="font-bold text-blue-600">{item.target_periods} ti·∫øt</span>
                                    </div>
                                    <div>
                                        <span className="text-gray-500 block mb-1">Chuy√™n m√¥n:</span>
                                        <div className="flex flex-wrap gap-1">
                                            {item.subjects && item.subjects.length > 0 ? (
                                                item.subjects.map(s => <span key={s} className="bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded text-xs border border-blue-100">{s}</span>)
                                            ) : <span className="text-gray-400 italic text-xs">Ch∆∞a c·∫≠p nh·∫≠t</span>}
                                        </div>
                                    </div>
                                    {item.unavailable_periods && item.unavailable_periods.length > 0 && (
                                        <div className="mt-2 text-xs text-red-500">
                                            üîí ƒê√£ ƒëƒÉng k√Ω {item.unavailable_periods.length} ti·∫øt b·∫≠n
                                        </div>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </window.AppLayout>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<TeacherPage />);
    </script>
</body>
</html>
