<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Xếp TKB - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/babel" src="js/common.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function SolverPage() {
            const [status, setStatus] = React.useState("idle");
            const [progress, setProgress] = React.useState(0);
            const [msg, setMsg] = React.useState("");
            const [results, setResults] = React.useState([]);
            const [classes, setClasses] = React.useState([]);
            const [viewClass, setViewClass] = React.useState("");

            React.useEffect(() => {
                const load = async () => setClasses(await window.api.call("/classes/") || []);
                load();
            }, []);

            const run = async () => {
                setStatus("running"); setProgress(0); setMsg("Đang khởi động...");
                const res = await window.api.call("/generate/", "POST");
                if(res?.task_id) poll(res.task_id); else setStatus("error");
            };

            const poll = (tid) => {
                const i = setInterval(async () => {
                    const res = await window.api.call(`/generate/status/${tid}`);
                    if(res) {
                        setProgress(res.progress); setMsg(res.message);
                        if(res.status === "completed") { clearInterval(i); setStatus("finished"); loadRes(tid); }
                        else if(res.status === "failed") { clearInterval(i); setStatus("error"); setMsg(res.error_log); }
                    }
                }, 2000);
            };

            const loadRes = async (tid) => {
                setResults(await window.api.call(`/generate/results/${tid}`));
            };

            return (
                <window.AppLayout>
                    <h1 className="text-2xl font-bold mb-6">Xếp Thời Khóa Biểu</h1>

                    <div className="bg-white p-8 rounded-xl shadow-sm text-center border border-dashed border-gray-300 mb-8">
                        {status === "idle" && (
                            <button onClick={run} className="bg-blue-600 text-white px-8 py-3 rounded-full font-bold text-lg shadow hover:bg-blue-700 transition transform hover:scale-105">
                                ▶ Bắt đầu Chạy
                            </button>
                        )}
                        
                        {status === "running" && (
                            <div className="max-w-md mx-auto">
                                <div className="flex justify-between text-sm font-medium mb-1"><span>{msg}</span><span>{progress}%</span></div>
                                <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div className="bg-blue-600 h-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                                </div>
                            </div>
                        )}

                        {status === "finished" && (
                            <div className="text-green-600">
                                <h3 className="font-bold text-xl">✅ Đã xếp xong!</h3>
                                <button onClick={() => setStatus("idle")} className="mt-2 underline text-sm">Chạy lại</button>
                            </div>
                        )}
                        
                        {status === "error" && <div className="text-red-500 font-bold">❌ Lỗi: {msg}</div>}
                    </div>

                    {results.length > 0 && (
                        <div>
                            <div className="flex items-center gap-4 mb-4">
                                <h3 className="font-bold text-lg">Xem Kết Quả:</h3>
                                <select className="border p-2 rounded w-64" onChange={e => setViewClass(e.target.value)}>
                                    <option value="">-- Chọn Lớp --</option>
                                    {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            
                            {viewClass && (
                                <div className="overflow-x-auto bg-white rounded shadow border">
                                    <table className="w-full text-center border-collapse">
                                        <thead>
                                            <tr>
                                                <th className="p-3 bg-gray-100 border w-16">Tiết</th>
                                                {["Hai","Ba","Tư","Năm","Sáu"].map(d=><th key={d} className="p-3 bg-gray-100 border font-bold">Thứ {d}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {[0,1,2,3,4,5,6,7,8].map(p => (
                                                <tr key={p}>
                                                    <td className="p-2 border font-bold text-gray-400 bg-gray-50">{p+1}</td>
                                                    {[0,1,2,3,4].map(d => {
                                                        const slot = results.find(r => r.class_id === viewClass && r.day === d && r.period === p);
                                                        return (
                                                            <td key={d} className="p-2 border min-w-[100px] h-16 hover:bg-blue-50">
                                                                {slot ? (
                                                                    <div>
                                                                        <div className="font-bold text-blue-700">{slot.subjects?.name}</div>
                                                                        <div className="text-xs text-gray-500">{slot.teachers?.short_name}</div>
                                                                    </div>
                                                                ) : "-"}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}
                </window.AppLayout>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<SolverPage />);
    </script>
</body>
</html>
