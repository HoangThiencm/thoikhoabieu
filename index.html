<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω ƒê·ª£t TKB - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="js/common.js" type="text/babel"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function ContextManager() {
            const [units, setUnits] = React.useState([]);
            const [years, setYears] = React.useState([]);
            const [sessions, setSessions] = React.useState([]);

            const [selectedUnit, setSelectedUnit] = React.useState("");
            const [selectedYear, setSelectedYear] = React.useState("");
            
            // UI States for creating new items
            const [isCreatingUnit, setIsCreatingUnit] = React.useState(false);
            const [newUnitName, setNewUnitName] = React.useState("");
            
            const [isCreatingYear, setIsCreatingYear] = React.useState(false);
            const [newYearName, setNewYearName] = React.useState("");

            const [isCreatingSession, setIsCreatingSession] = React.useState(false);
            const [newSessionName, setNewSessionName] = React.useState("");

            // Load Units on start
            React.useEffect(() => {
                const loadUnits = async () => setUnits(await window.api.call("/context/units") || []);
                loadUnits();
            }, []);

            // Load Years when Unit changes
            React.useEffect(() => {
                if (selectedUnit) {
                    const loadYears = async () => setYears(await window.api.call(`/context/years?unit_id=${selectedUnit}`) || []);
                    loadYears();
                    setSessions([]); setSelectedYear("");
                }
            }, [selectedUnit]);

            // Load Sessions when Year changes
            React.useEffect(() => {
                if (selectedYear) {
                    const loadSessions = async () => setSessions(await window.api.call(`/context/sessions?year_id=${selectedYear}`) || []);
                    loadSessions();
                }
            }, [selectedYear]);

            // Handlers
            const handleCreateUnit = async () => {
                if (!newUnitName) return;
                await window.api.call("/context/units", "POST", { name: newUnitName });
                setUnits(await window.api.call("/context/units"));
                setIsCreatingUnit(false); setNewUnitName("");
            };

            const handleCreateYear = async () => {
                if (!newYearName || !selectedUnit) return;
                await window.api.call("/context/years", "POST", { unit_id: selectedUnit, name: newYearName });
                setYears(await window.api.call(`/context/years?unit_id=${selectedUnit}`));
                setIsCreatingYear(false); setNewYearName("");
            };

            const handleCreateSession = async () => {
                if (!newSessionName || !selectedYear) return;
                await window.api.call("/context/sessions", "POST", { school_year_id: selectedYear, name: newSessionName });
                setSessions(await window.api.call(`/context/sessions?year_id=${selectedYear}`));
                setIsCreatingSession(false); setNewSessionName("");
            };

            const handleSelectSession = (sess) => {
                window.api.setSessionId(sess.id, sess.name);
                alert(`ƒê√£ ch·ªçn l√†m vi·ªác v·ªõi: ${sess.name}`);
                // Chuy·ªÉn h∆∞·ªõng sang trang gi√°o vi√™n ho·∫∑c dashboard
                // ·ªû ƒë√¢y ta reload ƒë·ªÉ c·∫≠p nh·∫≠t sidebar
                window.location.reload(); 
            };
            
            const handleDeleteSession = async (sessId) => {
                if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë·ª£t n√†y kh√¥ng? M·ªçi d·ªØ li·ªáu TKB b√™n trong s·∫Ω m·∫•t h·∫øt!")) {
                    await window.api.call(`/context/sessions/${sessId}`, "DELETE");
                    setSessions(await window.api.call(`/context/sessions?year_id=${selectedYear}`));
                }
            };

            return (
                <window.AppLayout>
                    <h1 className="text-3xl font-bold text-gray-800 mb-8">Qu·∫£n l√Ω ƒê·ª£t Th·ªùi Kh√≥a Bi·ªÉu</h1>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                        {/* C·ªòT 1: ƒê∆†N V·ªä */}
                        <div className="bg-white p-6 rounded-xl shadow border border-blue-100">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg text-blue-800">1. ƒê∆°n v·ªã / Tr∆∞·ªùng</h3>
                                <button onClick={() => setIsCreatingUnit(true)} className="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">+ Th√™m</button>
                            </div>
                            
                            {isCreatingUnit && (
                                <div className="mb-4 flex gap-2">
                                    <input autoFocus className="border p-1 text-sm rounded w-full" placeholder="T√™n tr∆∞·ªùng..." value={newUnitName} onChange={e => setNewUnitName(e.target.value)} />
                                    <button onClick={handleCreateUnit} className="bg-blue-600 text-white px-2 rounded text-sm">L∆∞u</button>
                                </div>
                            )}

                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {units.map(u => (
                                    <div key={u.id} 
                                         onClick={() => setSelectedUnit(u.id)}
                                         className={`p-3 rounded cursor-pointer border transition ${selectedUnit === u.id ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-50 border-gray-200'}`}>
                                        {u.name}
                                    </div>
                                ))}
                                {units.length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">Ch∆∞a c√≥ ƒë∆°n v·ªã n√†o.</p>}
                            </div>
                        </div>

                        {/* C·ªòT 2: NƒÇM H·ªåC */}
                        <div className={`bg-white p-6 rounded-xl shadow border border-green-100 transition-opacity ${!selectedUnit ? 'opacity-50 pointer-events-none' : ''}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg text-green-800">2. NƒÉm h·ªçc</h3>
                                <button onClick={() => setIsCreatingYear(true)} className="text-sm bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">+ Th√™m</button>
                            </div>

                            {isCreatingYear && (
                                <div className="mb-4 flex gap-2">
                                    <input autoFocus className="border p-1 text-sm rounded w-full" placeholder="VD: 2023-2024" value={newYearName} onChange={e => setNewYearName(e.target.value)} />
                                    <button onClick={handleCreateYear} className="bg-green-600 text-white px-2 rounded text-sm">L∆∞u</button>
                                </div>
                            )}

                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {years.map(y => (
                                    <div key={y.id} 
                                         onClick={() => setSelectedYear(y.id)}
                                         className={`p-3 rounded cursor-pointer border transition ${selectedYear === y.id ? 'bg-green-600 text-white border-green-600' : 'hover:bg-gray-50 border-gray-200'}`}>
                                        {y.name}
                                    </div>
                                ))}
                                {years.length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">Ch·ªçn ƒë∆°n v·ªã ƒë·ªÉ xem nƒÉm h·ªçc.</p>}
                            </div>
                        </div>

                        {/* C·ªòT 3: ƒê·ª¢T TKB */}
                        <div className={`bg-white p-6 rounded-xl shadow border border-orange-100 transition-opacity ${!selectedYear ? 'opacity-50 pointer-events-none' : ''}`}>
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg text-orange-800">3. ƒê·ª£t TKB</h3>
                                <button onClick={() => setIsCreatingSession(true)} className="text-sm bg-orange-100 text-orange-700 px-2 py-1 rounded hover:bg-orange-200">+ Th√™m</button>
                            </div>

                            {isCreatingSession && (
                                <div className="mb-4 flex gap-2">
                                    <input autoFocus className="border p-1 text-sm rounded w-full" placeholder="VD: H·ªçc k·ª≥ 1..." value={newSessionName} onChange={e => setNewSessionName(e.target.value)} />
                                    <button onClick={handleCreateSession} className="bg-orange-600 text-white px-2 rounded text-sm">L∆∞u</button>
                                </div>
                            )}

                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {sessions.map(s => (
                                    <div key={s.id} className="group relative">
                                        <div onClick={() => handleSelectSession(s)}
                                             className="p-3 rounded cursor-pointer border border-gray-200 hover:bg-orange-50 hover:border-orange-300 transition bg-white shadow-sm">
                                            <div className="font-bold text-gray-800">{s.name}</div>
                                            <div className="text-xs text-gray-500 flex justify-between mt-1">
                                                <span>{new Date(s.created_at).toLocaleDateString('vi-VN')}</span>
                                                {s.is_locked && <span className="text-red-500 font-bold">üîí ƒê√£ kh√≥a</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => handleDeleteSession(s.id)} 
                                            className="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">
                                            ‚úï
                                        </button>
                                    </div>
                                ))}
                                {sessions.length === 0 && <p className="text-sm text-gray-400 italic text-center py-4">Ch·ªçn nƒÉm h·ªçc ƒë·ªÉ xem c√°c ƒë·ª£t TKB.</p>}
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-8 p-4 bg-gray-100 rounded text-sm text-gray-600">
                        <b>H∆∞·ªõng d·∫´n:</b> Ch·ªçn l·∫ßn l∆∞·ª£t t·ª´ tr√°i sang ph·∫£i (1 -> 2 -> 3). Click v√†o m·ªôt <b>ƒê·ª£t TKB</b> ·ªü c·ªôt 3 ƒë·ªÉ k√≠ch ho·∫°t n√≥ v√† b·∫Øt ƒë·∫ßu l√†m vi·ªác (nh·∫≠p gi√°o vi√™n, x·∫øp l·ªãch...).
                    </div>
                </window.AppLayout>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<ContextManager />);
    </script>
</body>
</html>
