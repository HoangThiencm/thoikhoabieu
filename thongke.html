<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Thống Kê - SmartTKB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="text/babel" src="js/common.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        function StatsPage() {
            const [assignments, setAssignments] = React.useState([]);
            const [teachers, setTeachers] = React.useState([]);

            React.useEffect(() => {
                const load = async () => {
                    const [a, t] = await Promise.all([
                        window.api.call("/assignments/"),
                        window.api.call("/teachers/")
                    ]);
                    setAssignments(a || []);
                    setTeachers(t || []);
                };
                load();
            }, []);

            // Tính toán thống kê
            const teacherStats = teachers.map(t => {
                const myAssigns = assignments.filter(a => a.teacher_id === t.id);
                const totalPeriods = myAssigns.reduce((sum, a) => sum + (a.periods_per_week || 0), 0);
                return { ...t, count: myAssigns.length, periods: totalPeriods };
            }).sort((a,b) => b.periods - a.periods);

            return (
                <window.AppLayout>
                    <h1 className="text-2xl font-bold mb-6">Thống kê Phân công</h1>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-xl shadow border border-l-4 border-blue-500">
                            <h3 className="text-gray-500 font-bold uppercase text-sm">Tổng số tiết dạy</h3>
                            <p className="text-4xl font-bold mt-2">{assignments.reduce((s,a)=>s+a.periods_per_week, 0)}</p>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow border border-l-4 border-green-500">
                            <h3 className="text-gray-500 font-bold uppercase text-sm">Giáo viên tham gia</h3>
                            <p className="text-4xl font-bold mt-2">{teachers.filter(t => assignments.some(a=>a.teacher_id===t.id)).length} / {teachers.length}</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow border overflow-hidden">
                        <div className="p-4 bg-gray-50 font-bold border-b">Chi tiết theo Giáo viên</div>
                        <table className="w-full text-left">
                            <thead className="border-b">
                                <tr className="text-sm text-gray-500">
                                    <th className="p-3">Giáo viên</th>
                                    <th className="p-3">Số lớp dạy</th>
                                    <th className="p-3">Tổng số tiết/tuần</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {teacherStats.map(t => (
                                    <tr key={t.id} className="hover:bg-gray-50">
                                        <td className="p-3 font-medium">{t.name}</td>
                                        <td className="p-3">{t.count}</td>
                                        <td className="p-3 font-bold text-blue-600">{t.periods}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </window.AppLayout>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<StatsPage />);
    </script>
</body>
</html>
